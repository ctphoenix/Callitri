<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Day/Year Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .visualization {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .orbital-view {
            position: relative;
            width: 100%;
            height: 400px;
            margin-bottom: 30px;
        }

        canvas {
            border-radius: 10px;
            background: rgba(0, 0, 20, 0.5);
            display: block;
            margin: 0 auto;
        }

        .controls {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .value-display {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 5px;
            font-weight: 600;
            margin-left: 10px;
            min-width: 100px;
            text-align: center;
        }

        .day-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        button {
            background: rgba(255, 255, 255, 0.9);
            color: #1e3c72;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        button:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: 700;
        }

        .sky-view {
            height: 400px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preset-buttons button {
            padding: 6px 12px;
            font-size: 0.85em;
            flex: 0 1 auto;
        }

        .section-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Planet Day/Year Simulator</h1>

        <div class="visualization">
            <h2 style="margin-bottom: 15px;">Orbital View</h2>
            <div class="orbital-view">
                <canvas id="orbitalCanvas" width="800" height="400"></canvas>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>
                    Day of Year (30 days total):
                    <span class="value-display" id="dayOfYearDisplay">Day 0</span>
                </label>
                <div class="day-controls">
                    <input type="range" id="dayOfYear" min="0" max="29" value="0" step="1" style="flex: 1;">
                    <button id="playYearBtn">‚ñ∂ Play Year</button>
                </div>
                <div class="section-title" style="margin-top: 12px;">Quick Dates:</div>
                <div class="preset-buttons">
                    <button onclick="setDayOfYear(0)">Spring Equinox</button>
                    <button onclick="setDayOfYear(7.5)">Summer Solstice</button>
                    <button onclick="setDayOfYear(15)">Fall Equinox</button>
                    <button onclick="setDayOfYear(22.5)">Winter Solstice</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    Axial Tilt Angle (Yellow Bar):
                    <span class="value-display" id="axisAngleDisplay">90¬∞</span>
                </label>
                <input type="range" id="axisAngle" min="0" max="90" value="23" step="1">
                <div class="section-title" style="margin-top: 12px;">Presets:</div>
                <div class="preset-buttons">
                    <button onclick="setAxisAngle(0)">No Tilt (0¬∞)</button>
                    <button onclick="setAxisAngle(23.5)">Earth (23.5¬∞)</button>
                    <button onclick="setAxisAngle(90)">Extreme (90¬∞)</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    Latitude:
                    <span class="value-display" id="latitudeDisplay">0¬∞ (Equator)</span>
                </label>
                <input type="range" id="latitude" min="-90" max="90" value="0" step="1">
                <div class="section-title" style="margin-top: 12px;">Key Latitudes:</div>
                <div class="preset-buttons">
                    <button onclick="setLatitude(90)">North Pole</button>
                    <button onclick="setLatitude(66.5)">Arctic Circle</button>
                    <button onclick="setLatitude(23.5)">Tropic of Cancer</button>
                    <button onclick="setLatitude(0)">Equator</button>
                    <button onclick="setLatitude(-23.5)">Tropic of Capricorn</button>
                    <button onclick="setLatitude(-66.5)">Antarctic Circle</button>
                    <button onclick="setLatitude(-90)">South Pole</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    Hour of Day:
                    <span class="value-display" id="hourDisplay">12:00 (Noon)</span>
                </label>
                <div class="day-controls">
                    <input type="range" id="hourOfDay" min="0" max="24" value="12" step="0.25" style="flex: 1;">
                    <button id="playPauseBtn">‚ñ∂ Play Day</button>
                </div>
                <div class="section-title" style="margin-top: 12px;">Quick Times:</div>
                <div class="preset-buttons">
                    <button id="sunriseBtn" onclick="setToSunrise()">Sunrise</button>
                    <button onclick="setHourOfDay(12)">Noon</button>
                    <button id="sunsetBtn" onclick="setToSunset()">Sunset</button>
                    <button onclick="setHourOfDay(0)">Midnight</button>
                </div>
            </div>
        </div>

        <div class="visualization">
            <h2 style="margin-bottom: 15px;">Sky Chart (Azimuth √ó Altitude)</h2>
            <canvas id="skyCanvas" width="800" height="400" class="sky-view"></canvas>
        </div>

        <div class="info-panel">
            <div class="info-item">
                <div class="info-label">Day Length</div>
                <div class="info-value" id="dayLength">12h 00m</div>
            </div>
            <div class="info-item">
                <div class="info-label">Sunrise Time</div>
                <div class="info-value" id="sunriseTime">06:00</div>
            </div>
            <div class="info-item">
                <div class="info-label">Sunset Time</div>
                <div class="info-value" id="sunsetTime">18:00</div>
            </div>
            <div class="info-item">
                <div class="info-label">Solar Declination</div>
                <div class="info-value" id="declination">0.0¬∞</div>
            </div>
            <div class="info-item">
                <div class="info-label">Sun Altitude</div>
                <div class="info-value" id="altitude">--¬∞</div>
            </div>
            <div class="info-item">
                <div class="info-label">Sun Azimuth</div>
                <div class="info-value" id="azimuth">--¬∞</div>
            </div>
            <div class="info-item">
                <div class="info-label">Season</div>
                <div class="info-value" id="season">Spring</div>
            </div>
            <div class="info-item">
                <div class="info-label">Current Status</div>
                <div class="info-value" id="dayNight">Day</div>
            </div>
        </div>
    </div>

    <script>
        // Get canvas contexts
        const orbitalCanvas = document.getElementById('orbitalCanvas');
        const orbitalCtx = orbitalCanvas.getContext('2d');
        const skyCanvas = document.getElementById('skyCanvas');
        const skyCtx = skyCanvas.getContext('2d');

        // Get controls
        const dayOfYearInput = document.getElementById('dayOfYear');
        const axisAngleInput = document.getElementById('axisAngle');
        const latitudeInput = document.getElementById('latitude');
        const hourOfDayInput = document.getElementById('hourOfDay');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playYearBtn = document.getElementById('playYearBtn');

        // State
        let isPlayingDay = false;
        let isPlayingYear = false;
        let dayAnimationFrame = null;
        let yearAnimationFrame = null;
        let yearFrameCounter = 0;

        // Constants
        const AXIAL_TILT = 23.5; // degrees
        const DEG_TO_RAD = Math.PI / 180;
        const RAD_TO_DEG = 180 / Math.PI;

        // Calculate solar declination based on axis orientation relative to sun
        function calculateDeclination(orbitalAngle, axisAngle) {
            // axisAngle: 0¬∞ = perpendicular to orbital plane (no seasons)
            //           23.5¬∞ = Earth-like tilt
            //            90¬∞ = axis in the orbital plane (extreme seasons)
            // orbitalAngle: position in orbit
            //               0¬∞ = spring equinox (declination = 0)
            //              90¬∞ = summer solstice (max positive declination)
            //             180¬∞ = fall equinox (declination = 0)
            //             270¬∞ = winter solstice (max negative declination)

            // Declination varies sinusoidally with orbital position
            // Maximum declination equals the axial tilt
            const declination = axisAngle * Math.sin(orbitalAngle * DEG_TO_RAD);

            return declination;
        }

        // Calculate sunrise/sunset hour angles
        function calculateDayLength(latitude, declination) {
            const latRad = latitude * DEG_TO_RAD;
            const decRad = declination * DEG_TO_RAD;

            // Check for polar day/night
            const arg = -Math.tan(latRad) * Math.tan(decRad);

            if (arg >= 1) {
                return 0; // Polar night
            } else if (arg <= -1) {
                return 24; // Polar day
            }

            const hourAngle = Math.acos(arg) * RAD_TO_DEG;
            return (2 * hourAngle) / 15; // Convert to hours (15¬∞ per hour)
        }

        // Calculate sun position (altitude and azimuth)
        function calculateSunPosition(latitude, declination, hourAngle) {
            const latRad = latitude * DEG_TO_RAD;
            const decRad = declination * DEG_TO_RAD;
            const haRad = hourAngle * DEG_TO_RAD;

            // Altitude
            const sinAlt = Math.sin(latRad) * Math.sin(decRad) +
                          Math.cos(latRad) * Math.cos(decRad) * Math.cos(haRad);
            const altitude = Math.asin(sinAlt) * RAD_TO_DEG;

            // Azimuth (measured from North, clockwise)
            const cosAz = (Math.sin(decRad) - Math.sin(latRad) * sinAlt) /
                         (Math.cos(latRad) * Math.cos(Math.asin(sinAlt)));
            let azimuth = Math.acos(Math.max(-1, Math.min(1, cosAz))) * RAD_TO_DEG;

            // Adjust azimuth for afternoon (when hour angle > 0)
            if (hourAngle > 0) {
                azimuth = 360 - azimuth;
            }

            return { altitude, azimuth };
        }

        // Get season name
        function getSeason(orbitalAngle) {
            if (orbitalAngle < 45 || orbitalAngle >= 315) return 'Spring';
            if (orbitalAngle < 135) return 'Summer';
            if (orbitalAngle < 225) return 'Fall';
            return 'Winter';
        }

        // Get season emoji
        function getSeasonEmoji(orbitalAngle) {
            if (orbitalAngle < 45 || orbitalAngle >= 315) return 'üå∏';
            if (orbitalAngle < 135) return '‚òÄÔ∏è';
            if (orbitalAngle < 225) return 'üçÇ';
            return '‚ùÑÔ∏è';
        }

        // Draw orbital view
        function drawOrbitalView(orbitalAngle, declination, rotationAngle, latitude, hourOfDay) {
            const width = orbitalCanvas.width;
            const height = orbitalCanvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const orbitRadius = 150;

            // Clear canvas
            orbitalCtx.fillStyle = 'rgba(0, 0, 20, 0.5)';
            orbitalCtx.fillRect(0, 0, width, height);

            // Draw orbit
            orbitalCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            orbitalCtx.lineWidth = 2;
            orbitalCtx.setLineDash([5, 5]);
            orbitalCtx.beginPath();
            orbitalCtx.arc(centerX, centerY, orbitRadius, 0, 2 * Math.PI);
            orbitalCtx.stroke();
            orbitalCtx.setLineDash([]);

            // Draw reference lines
            orbitalCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            orbitalCtx.lineWidth = 1;

            // Equinoxes and solstices
            for (let i = 0; i < 4; i++) {
                const angle = i * 90 * DEG_TO_RAD;
                const x = centerX + orbitRadius * Math.cos(angle);
                const y = centerY + orbitRadius * Math.sin(angle);
                orbitalCtx.beginPath();
                orbitalCtx.arc(x, y, 3, 0, 2 * Math.PI);
                orbitalCtx.fill();
            }

            // Draw sun with rays
            // Sun rays
            orbitalCtx.strokeStyle = 'rgba(253, 184, 19, 0.4)';
            orbitalCtx.lineWidth = 3;
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30) * DEG_TO_RAD;
                const x1 = centerX + 25 * Math.cos(angle);
                const y1 = centerY + 25 * Math.sin(angle);
                const x2 = centerX + 45 * Math.cos(angle);
                const y2 = centerY + 45 * Math.sin(angle);
                orbitalCtx.beginPath();
                orbitalCtx.moveTo(x1, y1);
                orbitalCtx.lineTo(x2, y2);
                orbitalCtx.stroke();
            }

            // Sun glow
            const gradient = orbitalCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 40);
            gradient.addColorStop(0, '#FDB813');
            gradient.addColorStop(0.5, '#FFEB3B');
            gradient.addColorStop(1, 'rgba(253, 184, 19, 0)');
            orbitalCtx.fillStyle = gradient;
            orbitalCtx.beginPath();
            orbitalCtx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
            orbitalCtx.fill();

            // Sun body
            orbitalCtx.fillStyle = '#FDB813';
            orbitalCtx.beginPath();
            orbitalCtx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
            orbitalCtx.fill();

            // Draw Earth
            const earthAngle = orbitalAngle * DEG_TO_RAD;
            const earthX = centerX + orbitRadius * Math.cos(earthAngle);
            const earthY = centerY + orbitRadius * Math.sin(earthAngle);

            // Earth body
            const earthGradient = orbitalCtx.createRadialGradient(earthX - 5, earthY - 5, 0, earthX, earthY, 25);
            earthGradient.addColorStop(0, '#6FB1FC');
            earthGradient.addColorStop(1, '#4A90E2');
            orbitalCtx.fillStyle = earthGradient;
            orbitalCtx.beginPath();
            orbitalCtx.arc(earthX, earthY, 25, 0, 2 * Math.PI);
            orbitalCtx.fill();

            // Earth outline
            orbitalCtx.strokeStyle = '#2E5C8A';
            orbitalCtx.lineWidth = 2;
            orbitalCtx.stroke();

            // Draw day/night terminator (always perpendicular to sun direction)
            orbitalCtx.save();
            orbitalCtx.translate(earthX, earthY);

            // Calculate direction to sun for terminator
            const sunDirection = Math.atan2(centerY - earthY, centerX - earthX);
            orbitalCtx.rotate(sunDirection);

            // Draw night side (RIGHT half, away from sun)
            orbitalCtx.fillStyle = 'rgba(0, 0, 40, 0.6)';
            orbitalCtx.beginPath();
            orbitalCtx.arc(0, 0, 25, -Math.PI / 2, Math.PI / 2, true);
            orbitalCtx.closePath();
            orbitalCtx.fill();

            // Draw terminator line
            orbitalCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            orbitalCtx.lineWidth = 1;
            orbitalCtx.beginPath();
            orbitalCtx.moveTo(0, -25);
            orbitalCtx.lineTo(0, 25);
            orbitalCtx.stroke();

            orbitalCtx.restore();

            // Draw axis - rotates with Planet Rotation Angle slider
            // Add 90¬∞ so that 0¬∞ = vertical (perpendicular to orbital plane)
            const axisAngle = (rotationAngle + 90) * DEG_TO_RAD;
            const axisLength = 40;
            const axisDx = axisLength * Math.cos(axisAngle);
            const axisDy = axisLength * Math.sin(axisAngle);

            orbitalCtx.strokeStyle = '#FFD700';
            orbitalCtx.lineWidth = 3;
            orbitalCtx.beginPath();
            orbitalCtx.moveTo(earthX - axisDx, earthY - axisDy);
            orbitalCtx.lineTo(earthX + axisDx, earthY + axisDy);
            orbitalCtx.stroke();

            // Draw N/S labels on axis
            orbitalCtx.fillStyle = '#FFD700';
            orbitalCtx.font = 'bold 14px sans-serif';
            orbitalCtx.textAlign = 'center';
            orbitalCtx.textBaseline = 'middle';

            // North pole (top of axis)
            const northX = earthX + axisDx;
            const northY = earthY + axisDy;
            orbitalCtx.fillStyle = '#000';
            orbitalCtx.fillText('N', northX, northY);
            orbitalCtx.strokeStyle = '#FFD700';
            orbitalCtx.lineWidth = 3;
            orbitalCtx.strokeText('N', northX, northY);

            // South pole (bottom of axis)
            const southX = earthX - axisDx;
            const southY = earthY - axisDy;
            orbitalCtx.fillStyle = '#000';
            orbitalCtx.fillText('S', southX, southY);
            orbitalCtx.strokeStyle = '#FFD700';
            orbitalCtx.lineWidth = 3;
            orbitalCtx.strokeText('S', southX, southY);

            // Draw equator line (perpendicular to axis, rotates with planet)
            orbitalCtx.save();
            orbitalCtx.translate(earthX, earthY);
            orbitalCtx.rotate(sunDirection); // Align with sun
            const hourAngleRad = (hourOfDay - 12) * 15 * DEG_TO_RAD; // Planet rotation
            orbitalCtx.rotate(hourAngleRad); // Rotate with daily rotation
            orbitalCtx.rotate(axisAngle + Math.PI / 2); // Perpendicular to axis
            orbitalCtx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            orbitalCtx.lineWidth = 2;
            orbitalCtx.setLineDash([3, 3]);
            orbitalCtx.beginPath();
            orbitalCtx.moveTo(-25, 0);
            orbitalCtx.lineTo(25, 0);
            orbitalCtx.stroke();
            orbitalCtx.setLineDash([]);
            orbitalCtx.restore();

            // Draw latitude marker at FIXED location on planet (rotates with daily rotation)
            // The marker represents a person standing at this latitude
            // As hours pass, the planet rotates and this person moves through day/night
            orbitalCtx.save();
            orbitalCtx.translate(earthX, earthY);
            orbitalCtx.rotate(sunDirection); // Align with sun
            orbitalCtx.rotate(hourAngleRad); // Rotate planet based on time of day

            // Now in planet-fixed frame rotated to current hour:
            // - At hour 12, observer faces sun (x-axis points toward sun)
            // - At hour 0, observer faces away (x-axis points away from sun)
            // - At hour 6/18, observer is at sunrise/sunset
            const latRad = latitude * DEG_TO_RAD;

            // Position along observer's meridian at latitude L:
            // - Component along axis: sin(L)
            // - Component in equatorial plane toward observer: cos(L)
            const markerX = 25 * (Math.sin(latRad) * Math.cos(axisAngle) + Math.cos(latRad));
            const markerY = 25 * Math.sin(latRad) * Math.sin(axisAngle);

            orbitalCtx.fillStyle = '#FF6B6B';
            orbitalCtx.strokeStyle = '#FFF';
            orbitalCtx.lineWidth = 2;
            orbitalCtx.beginPath();
            orbitalCtx.arc(markerX, markerY, 5, 0, 2 * Math.PI);
            orbitalCtx.fill();
            orbitalCtx.stroke();

            orbitalCtx.restore();

            // Draw labels
            orbitalCtx.fillStyle = '#fff';
            orbitalCtx.font = '14px sans-serif';
            orbitalCtx.textAlign = 'center';

            const labels = [
                { angle: 0, text: 'Spring\nEquinox', offset: 30 },
                { angle: 90, text: 'Summer\nSolstice', offset: 30 },
                { angle: 180, text: 'Fall\nEquinox', offset: 30 },
                { angle: 270, text: 'Winter\nSolstice', offset: 30 }
            ];

            labels.forEach(label => {
                const angle = label.angle * DEG_TO_RAD;
                const x = centerX + (orbitRadius + label.offset) * Math.cos(angle);
                const y = centerY + (orbitRadius + label.offset) * Math.sin(angle);

                const lines = label.text.split('\n');
                lines.forEach((line, i) => {
                    orbitalCtx.fillText(line, x, y + i * 16);
                });
            });
        }

        // Draw sky view as azimuth-altitude chart
        function drawSkyView(latitude, declination, hourAngle) {
            const width = skyCanvas.width;
            const height = skyCanvas.height;

            // Calculate current sun position
            const sunPos = calculateSunPosition(latitude, declination, hourAngle);

            // Background gradient (brightness varies with y-position and time of day)
            const gradient = skyCtx.createLinearGradient(0, 0, 0, height);

            // Brightness factor based on sun altitude
            let brightness = 1.0;
            if (sunPos.altitude < -18) {
                brightness = 0; // Night (astronomical twilight)
            } else if (sunPos.altitude < 0) {
                brightness = (sunPos.altitude + 18) / 18; // Twilight
            }

            const skyBlue = [135, 206, 235]; // #87CEEB
            const horizonBlue = [212, 232, 240]; // #D4E8F0

            gradient.addColorStop(0, `rgb(${Math.floor(skyBlue[0] * brightness)}, ${Math.floor(skyBlue[1] * brightness)}, ${Math.floor(skyBlue[2] * brightness)})`);
            gradient.addColorStop(0.7, `rgb(${Math.floor((skyBlue[0] + horizonBlue[0])/2 * brightness)}, ${Math.floor((skyBlue[1] + horizonBlue[1])/2 * brightness)}, ${Math.floor((skyBlue[2] + horizonBlue[2])/2 * brightness)})`);
            gradient.addColorStop(1, `rgb(${Math.floor(horizonBlue[0] * brightness)}, ${Math.floor(horizonBlue[1] * brightness)}, ${Math.floor(horizonBlue[2] * brightness)})`);

            skyCtx.fillStyle = gradient;
            skyCtx.fillRect(0, 0, width, height);

            // Ground (below horizon)
            const horizonY = height - 50; // Reserve 50px at bottom for grass
            skyCtx.fillStyle = 'rgba(34, 139, 34, 0.5)';
            skyCtx.fillRect(0, horizonY, width, height - horizonY);

            // Grid lines
            skyCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            skyCtx.lineWidth = 1;

            // Altitude grid lines (every 15¬∞)
            for (let alt = 0; alt <= 90; alt += 15) {
                const y = horizonY - (alt / 90) * (horizonY - 20);
                skyCtx.beginPath();
                skyCtx.moveTo(0, y);
                skyCtx.lineTo(width, y);
                skyCtx.stroke();
            }

            // Azimuth range: 85¬∞ to 275¬∞ (190¬∞ total, padding E/W by 5¬∞)
            const minAz = 85;
            const maxAz = 275;
            const azRange = maxAz - minAz;

            // Azimuth grid lines (every 45¬∞)
            for (let az = 90; az <= 270; az += 45) {
                if (az >= minAz && az <= maxAz) {
                    const x = ((az - minAz) / azRange) * width;
                    skyCtx.beginPath();
                    skyCtx.moveTo(x, 20);
                    skyCtx.lineTo(x, horizonY);
                    skyCtx.stroke();
                }
            }

            // Horizon line (thicker)
            skyCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            skyCtx.lineWidth = 2;
            skyCtx.beginPath();
            skyCtx.moveTo(0, horizonY);
            skyCtx.lineTo(width, horizonY);
            skyCtx.stroke();

            // Labels
            skyCtx.fillStyle = 'rgba(0, 0, 0, 0.7)'; // Darker for visibility
            skyCtx.font = '12px sans-serif';
            skyCtx.textAlign = 'center';

            // Azimuth labels
            const azLabels = [
                { az: 90, label: 'E' },
                { az: 135, label: 'SE' },
                { az: 180, label: 'S' },
                { az: 225, label: 'SW' },
                { az: 270, label: 'W' }
            ];
            azLabels.forEach(({ az, label }) => {
                if (az >= minAz && az <= maxAz) {
                    const x = ((az - minAz) / azRange) * width;
                    skyCtx.fillText(label, x, horizonY + 20);
                }
            });

            // Altitude labels
            skyCtx.textAlign = 'left';
            for (let alt = 0; alt <= 90; alt += 30) {
                const y = horizonY - (alt / 90) * (horizonY - 20);
                skyCtx.fillText(`${alt}¬∞`, 5, y - 3);
            }

            // "Zenith" label
            skyCtx.textAlign = 'center';
            skyCtx.fillText('Zenith', width / 2, 15);

            // Draw sun path for full day
            skyCtx.strokeStyle = 'rgba(255, 200, 0, 0.4)';
            skyCtx.lineWidth = 2;
            skyCtx.setLineDash([5, 5]);
            skyCtx.beginPath();

            let pathStarted = false;
            for (let h = 0; h <= 24; h += 0.25) {
                const ha = (h - 12) * 15; // Hour angle
                const pos = calculateSunPosition(latitude, declination, ha);

                if (pos.altitude > -5 && pos.azimuth >= minAz && pos.azimuth <= maxAz) {
                    const x = ((pos.azimuth - minAz) / azRange) * width;
                    const y = horizonY - (Math.max(0, pos.altitude) / 90) * (horizonY - 20);

                    if (!pathStarted) {
                        skyCtx.moveTo(x, y);
                        pathStarted = true;
                    } else {
                        skyCtx.lineTo(x, y);
                    }
                }
            }
            skyCtx.stroke();
            skyCtx.setLineDash([]);

            // Draw current sun position
            if (sunPos.altitude > -5 && sunPos.azimuth >= minAz && sunPos.azimuth <= maxAz) {
                const sunX = ((sunPos.azimuth - minAz) / azRange) * width;
                const sunY = horizonY - (Math.max(0, sunPos.altitude) / 90) * (horizonY - 20);

                // Sun glow
                const sunSize = sunPos.altitude > 0 ? 20 : 15;
                const sunGradient = skyCtx.createRadialGradient(sunX, sunY, 0, sunX, sunY, sunSize);
                sunGradient.addColorStop(0, '#FFF9E6');
                sunGradient.addColorStop(0.4, '#FFD700');
                sunGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                skyCtx.fillStyle = sunGradient;
                skyCtx.beginPath();
                skyCtx.arc(sunX, sunY, sunSize, 0, 2 * Math.PI);
                skyCtx.fill();

                // Sun body
                skyCtx.fillStyle = '#FDB813';
                skyCtx.beginPath();
                skyCtx.arc(sunX, sunY, 10, 0, 2 * Math.PI);
                skyCtx.fill();

                // Sun outline
                skyCtx.strokeStyle = '#FFF';
                skyCtx.lineWidth = 1;
                skyCtx.stroke();
            }
        }

        // Update display values
        function updateDisplay() {
            const dayOfYear = parseFloat(dayOfYearInput.value);
            const axisAngle = parseFloat(axisAngleInput.value);
            const latitude = parseFloat(latitudeInput.value);
            const hourOfDay = parseFloat(hourOfDayInput.value);

            // Convert day of year (0-29) to orbital angle (0-360¬∞)
            const orbitalAngle = (dayOfYear * 360 / 30) % 360;

            // Convert hour of day to hour angle (solar noon = 0)
            const hourAngle = (hourOfDay - 12) * 15;

            const declination = calculateDeclination(orbitalAngle, axisAngle);
            const dayLength = calculateDayLength(latitude, declination);
            const sunPos = calculateSunPosition(latitude, declination, hourAngle);

            // Update day of year display
            document.getElementById('dayOfYearDisplay').textContent = `Day ${dayOfYear}`;

            // Update axis angle display
            document.getElementById('axisAngleDisplay').textContent = `${axisAngle}¬∞`;

            // Update latitude display
            const latLabel = latitude === 0 ? 'Equator' :
                           latitude > 0 ? `${latitude}¬∞ N` : `${Math.abs(latitude)}¬∞ S`;
            document.getElementById('latitudeDisplay').textContent = `${latLabel}`;

            // Update hour display
            const hours = Math.floor(hourOfDay);
            const minutes = Math.floor((hourOfDay - hours) * 60);
            const timeLabel = hours === 12 && minutes === 0 ? 'Noon' :
                            hours === 0 && minutes === 0 ? 'Midnight' : '';
            document.getElementById('hourDisplay').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}${timeLabel ? ' (' + timeLabel + ')' : ''}`;

            // Update info panel
            const dayHours = Math.floor(dayLength);
            const dayMinutes = Math.floor((dayLength - dayHours) * 60);
            document.getElementById('dayLength').textContent =
                dayLength === 0 ? 'Polar Night' :
                dayLength === 24 ? 'Polar Day' :
                `${dayHours}h ${dayMinutes}m`;

            // Calculate sunrise and sunset times
            if (dayLength === 0) {
                document.getElementById('sunriseTime').textContent = 'N/A';
                document.getElementById('sunsetTime').textContent = 'N/A';
            } else if (dayLength === 24) {
                document.getElementById('sunriseTime').textContent = 'N/A';
                document.getElementById('sunsetTime').textContent = 'N/A';
            } else {
                const sunriseHour = 12 - dayLength / 2;
                const sunsetHour = 12 + dayLength / 2;

                const srH = Math.floor(sunriseHour);
                const srM = Math.floor((sunriseHour - srH) * 60);
                const ssH = Math.floor(sunsetHour);
                const ssM = Math.floor((sunsetHour - ssH) * 60);

                document.getElementById('sunriseTime').textContent =
                    `${srH.toString().padStart(2, '0')}:${srM.toString().padStart(2, '0')}`;
                document.getElementById('sunsetTime').textContent =
                    `${ssH.toString().padStart(2, '0')}:${ssM.toString().padStart(2, '0')}`;
            }

            document.getElementById('declination').textContent = `${declination.toFixed(1)}¬∞`;

            const season = getSeason(orbitalAngle);
            const seasonEmoji = getSeasonEmoji(orbitalAngle);
            document.getElementById('season').textContent = `${season} ${seasonEmoji}`;

            if (sunPos.altitude > 0) {
                document.getElementById('altitude').textContent = `${sunPos.altitude.toFixed(1)}¬∞`;
                document.getElementById('azimuth').textContent = `${sunPos.azimuth.toFixed(1)}¬∞`;
                document.getElementById('dayNight').textContent = '‚òÄÔ∏è Day';
            } else if (sunPos.altitude > -6) {
                document.getElementById('altitude').textContent = `${sunPos.altitude.toFixed(1)}¬∞`;
                document.getElementById('azimuth').textContent = `${sunPos.azimuth.toFixed(1)}¬∞`;
                document.getElementById('dayNight').textContent = 'üåÖ Twilight';
            } else {
                document.getElementById('altitude').textContent = `${sunPos.altitude.toFixed(1)}¬∞`;
                document.getElementById('azimuth').textContent = `${sunPos.azimuth.toFixed(1)}¬∞`;
                document.getElementById('dayNight').textContent = 'üåô Night';
            }

            // Redraw visualizations
            drawOrbitalView(orbitalAngle, declination, axisAngle, latitude, hourOfDay);
            drawSkyView(latitude, declination, hourAngle);
        }

        // Animation loop for day
        function animateDay() {
            let hourOfDay = parseFloat(hourOfDayInput.value);
            hourOfDay = (hourOfDay + 0.2) % 24;
            hourOfDayInput.value = hourOfDay.toFixed(2);
            updateDisplay();

            if (isPlayingDay) {
                dayAnimationFrame = requestAnimationFrame(animateDay);
            }
        }

        // Animation loop for year
        function animateYear() {
            yearFrameCounter++;
            // Only advance day every 30 frames (slower animation)
            if (yearFrameCounter >= 30) {
                yearFrameCounter = 0;
                let dayOfYear = parseInt(dayOfYearInput.value);
                dayOfYear = (dayOfYear + 1) % 30;
                dayOfYearInput.value = dayOfYear;
                updateDisplay();
            }

            if (isPlayingYear) {
                yearAnimationFrame = requestAnimationFrame(animateYear);
            }
        }

        // Event listeners
        dayOfYearInput.addEventListener('input', updateDisplay);
        axisAngleInput.addEventListener('input', updateDisplay);
        latitudeInput.addEventListener('input', updateDisplay);
        hourOfDayInput.addEventListener('input', updateDisplay);

        playPauseBtn.addEventListener('click', () => {
            isPlayingDay = !isPlayingDay;
            if (isPlayingDay) {
                playPauseBtn.textContent = '‚è∏ Pause';
                animateDay();
            } else {
                playPauseBtn.textContent = '‚ñ∂ Play Day';
                if (dayAnimationFrame) {
                    cancelAnimationFrame(dayAnimationFrame);
                }
            }
        });

        playYearBtn.addEventListener('click', () => {
            isPlayingYear = !isPlayingYear;
            if (isPlayingYear) {
                playYearBtn.textContent = '‚è∏ Pause';
                yearFrameCounter = 0; // Reset frame counter
                animateYear();
            } else {
                playYearBtn.textContent = '‚ñ∂ Play Year';
                if (yearAnimationFrame) {
                    cancelAnimationFrame(yearAnimationFrame);
                }
            }
        });

        // Preset button functions
        function setDayOfYear(day) {
            dayOfYearInput.value = day;
            updateDisplay();
        }

        function setAxisAngle(angle) {
            axisAngleInput.value = angle;
            updateDisplay();
        }

        function setLatitude(lat) {
            latitudeInput.value = lat;
            updateDisplay();
        }

        function setHourOfDay(hour) {
            hourOfDayInput.value = hour;
            updateDisplay();
        }

        function setToSunrise() {
            const dayOfYear = parseFloat(dayOfYearInput.value);
            const axisAngle = parseFloat(axisAngleInput.value);
            const latitude = parseFloat(latitudeInput.value);

            const orbitalAngle = (dayOfYear * 360 / 30) % 360;
            const declination = calculateDeclination(orbitalAngle, axisAngle);
            const dayLength = calculateDayLength(latitude, declination);

            if (dayLength > 0 && dayLength < 24) {
                const sunriseHour = 12 - dayLength / 2;
                hourOfDayInput.value = sunriseHour.toFixed(2);
                updateDisplay();
            }
        }

        function setToSunset() {
            const dayOfYear = parseFloat(dayOfYearInput.value);
            const axisAngle = parseFloat(axisAngleInput.value);
            const latitude = parseFloat(latitudeInput.value);

            const orbitalAngle = (dayOfYear * 360 / 30) % 360;
            const declination = calculateDeclination(orbitalAngle, axisAngle);
            const dayLength = calculateDayLength(latitude, declination);

            if (dayLength > 0 && dayLength < 24) {
                const sunsetHour = 12 + dayLength / 2;
                hourOfDayInput.value = sunsetHour.toFixed(2);
                updateDisplay();
            }
        }

        // Initial draw
        updateDisplay();
    </script>
</body>
</html>
